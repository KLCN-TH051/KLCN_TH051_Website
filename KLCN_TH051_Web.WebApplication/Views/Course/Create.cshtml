@{
    ViewData["Title"] = "Tạo khóa học";
}

<div class="container mt-5">
    <h2 class="text-center mb-4">Tạo khóa học mới</h2>

    <form id="createCourseForm">
        <div class="mb-3">
            <label for="courseName" class="form-label">Tên khóa học</label>
            <input type="text" class="form-control" id="courseName" placeholder="Nhập tên khóa học" required>
        </div>

        <div class="mb-3">
            <label for="courseDescription" class="form-label">Mô tả</label>
            <textarea class="form-control" id="courseDescription" rows="3" placeholder="Mô tả ngắn" required></textarea>
        </div>

        <div class="mb-3">
            <label for="subject" class="form-label">Môn học</label>
            <select class="form-select" id="subject" required>
                <option value="">-- Chọn môn học --</option>
            </select>
        </div>

        <div class="d-flex justify-content-end">
            <button type="reset" class="btn btn-secondary me-2">Làm lại</button>
            <button type="submit" class="btn btn-primary">Gửi yêu cầu tạo</button>
        </div>
    </form>

    <div id="resultMessage" class="mt-4"></div>
</div>

@section Scripts {
    <script>
        const subjectSelect = document.getElementById("subject");

        // 🚀 Lấy danh sách môn học
        async function loadSubjects() {
            try {
                const res = await fetch("/api/monhoc");
                const data = await res.json();

                data.forEach(mh => {
                    const opt = document.createElement("option");
                    opt.value = mh.id;
                    opt.textContent = `${mh.ten} (${mh.code})`;
                    subjectSelect.appendChild(opt);
                });
            } catch {
                document.getElementById("resultMessage").innerHTML =
                    `<div class="alert alert-danger">Không thể tải danh sách môn học.</div>`;
            }
        }

        // 📤 Gửi yêu cầu tạo khóa học
        document.getElementById("createCourseForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const data = {
                ten: document.getElementById("courseName").value,
                moTa: document.getElementById("courseDescription").value,
                idMH: subjectSelect.value
            };

            try {
                const res = await fetch("/api/khoahoc", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    document.getElementById("resultMessage").innerHTML =
                        `<div class="alert alert-success">Yêu cầu tạo khóa học đã được gửi! Vui lòng chờ duyệt.</div>`;
                    e.target.reset();
                } else {
                    const err = await res.json();
                    document.getElementById("resultMessage").innerHTML =
                        `<div class="alert alert-danger">Lỗi: ${err.message || 'Không thể tạo khóa học.'}</div>`;
                }
            } catch {
                document.getElementById("resultMessage").innerHTML =
                    `<div class="alert alert-danger">Lỗi kết nối API.</div>`;
            }
        });

        loadSubjects();
    </script>
}
