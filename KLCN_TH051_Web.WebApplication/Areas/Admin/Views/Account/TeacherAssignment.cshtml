@{
    ViewData["Title"] = "Phân công giáo viên";
    var apiUrl = ViewData["ApiUrl"]?.ToString() ?? "";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">

<div class="container mt-4">
    <h3>@ViewData["Title"]</h3>

    <div class="mb-3">
        <button class="btn btn-primary" id="btnAdd">Thêm phân công</button>
    </div>

    <table class="table table-bordered table-striped" id="tableAssignments">
        <thead>
            <tr>
                <th>#</th>
                <th>Giáo viên</th>
                <th>Môn học</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal Thêm/Sửa -->
<div class="modal fade" id="assignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Phân công giáo viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignmentForm">
                    <input type="hidden" id="assignmentId" />
                    <div class="mb-3">
                        <label for="teacherSelect" class="form-label">Giáo viên</label>
                        <select class="form-select" id="teacherSelect" required></select>
                    </div>
                    <div class="mb-3">
                        <label for="subjectSelect" class="form-label">Môn học</label>
                        <select class="form-select" id="subjectSelect" required></select>
                    </div>
                    <button type="submit" class="btn btn-success">Lưu</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Xóa -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc muốn xóa phân công này?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const apiBase = "@(apiUrl)/api/TeacherAssignments";
    const apiUsers = "@(apiUrl)/api/Account/teachers"; // sửa đúng route
    const apiSubjects = "@(apiUrl)/api/Subjects";

    const tableBody = document.querySelector("#tableAssignments tbody");
    const assignmentModal = new bootstrap.Modal(document.getElementById('assignmentModal'));
    const assignmentForm = document.getElementById("assignmentForm");
    const assignmentIdInput = document.getElementById("assignmentId");
    const teacherSelect = document.getElementById("teacherSelect");
    const subjectSelect = document.getElementById("subjectSelect");

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let deleteId = null;

    // Load tất cả phân công
    async function loadAssignments() {
        try {
            const res = await axios.get(apiBase);
            tableBody.innerHTML = "";
            res.data.forEach((a, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${a.teacherName}</td>
                    <td>${a.subjectName}</td>
                    <td>
                        <button class="btn btn-sm btn-warning btnEdit" data-id="${a.id}">Sửa</button>
                        <button class="btn btn-sm btn-danger btnDelete" data-id="${a.id}">Xóa</button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        } catch (err) {
            console.error(err);
            alert("Lỗi load danh sách phân công");
        }
    }

    // Load combobox giáo viên & môn học
    async function loadOptions() {
        try {
            const [teachersRes, subjectsRes] = await Promise.all([
                axios.get(apiUsers),
                axios.get(apiSubjects)
            ]);

            teacherSelect.innerHTML = teachersRes.data
                .map(t => `<option value="${t.id}">${t.fullName}</option>`).join("");

            subjectSelect.innerHTML = subjectsRes.data
                .map(s => `<option value="${s.id}">${s.name}</option>`).join("");
        } catch (err) {
            console.error(err);
            alert("Lỗi load danh sách giáo viên hoặc môn học");
        }
    }

    // Thêm mới
    document.getElementById("btnAdd").addEventListener("click", async () => {
        assignmentIdInput.value = "";
        await loadOptions();
        assignmentModal.show();
    });

    // Submit form Thêm/Sửa
    assignmentForm.addEventListener("submit", async e => {
        e.preventDefault();
        const id = assignmentIdInput.value;
        const data = {
            teacherId: parseInt(teacherSelect.value),
            subjectId: parseInt(subjectSelect.value)
        };
        try {
            if (id) {
                await axios.put(`${apiBase}/${id}`, data);
            } else {
                await axios.post(apiBase, data);
            }
            assignmentModal.hide();
            await loadAssignments();
        } catch (err) {
            alert(err.response?.data?.message || err.message);
        }
    });

    // Sửa/Xóa
    tableBody.addEventListener("click", async e => {
        const id = e.target.dataset.id;
        if (!id) return;

        if (e.target.classList.contains("btnDelete")) {
            deleteId = id;
            deleteModal.show();
        } else if (e.target.classList.contains("btnEdit")) {
            assignmentIdInput.value = id;
            await loadOptions();
            try {
                const res = await axios.get(apiBase);
                const assignment = res.data.find(a => a.id == id);
                if (assignment) {
                    teacherSelect.value = assignment.teacherId;
                    subjectSelect.value = assignment.subjectId;
                    assignmentModal.show();
                }
            } catch (err) {
                console.error(err);
                alert("Lỗi load phân công để sửa");
            }
        }
    });

    // Xác nhận Xóa
    confirmDeleteBtn.addEventListener("click", async () => {
        if (!deleteId) return;
        try {
            await axios.delete(`${apiBase}/${deleteId}`);
            deleteModal.hide();
            deleteId = null;
            await loadAssignments();
        } catch (err) {
            alert(err.response?.data?.message || err.message);
        }
    });

    // Load khi vào trang
    loadAssignments();
</script>
