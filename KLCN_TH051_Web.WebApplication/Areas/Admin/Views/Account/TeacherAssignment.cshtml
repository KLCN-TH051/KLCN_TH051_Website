@{
    ViewData["Title"] = "Danh sách phân công giáo viên";
}

<div class="container mt-4">

    <div class="d-flex justify-content-between mb-3">
        <h3>Danh sách phân công giáo viên</h3>
        <button class="btn btn-primary" id="btnAdd">+ Thêm phân công</button>
    </div>

    <table class="table table-bordered" id="tblAssignments">
        <thead>
            <tr>
                <th>ID</th>
                <th>Giáo viên</th>
                <th>Môn học</th>
                <th style="width: 140px;">Tùy chọn</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>


<!-- ========================================================= -->
<!-- POPUP THÊM + SỬA (DÙNG CHUNG) -->
<!-- ========================================================= -->
<div class="modal fade" id="assignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm phân công</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="assignmentId" />

                <div class="mb-3">
                    <label>Giáo viên</label>
                    <select class="form-select" id="teacherSelect"></select>
                </div>

                <div class="mb-3">
                    <label>Môn học</label>
                    <select class="form-select" id="subjectSelect"></select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-primary" id="btnSave">Lưu</button>
            </div>

        </div>
    </div>
</div>


<!-- ========================================================= -->
<!-- POPUP XÓA -->
<!-- ========================================================= -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Xóa phân công</h5>
            </div>

            <div class="modal-body">
                <p>Bạn có chắc muốn xóa phân công này?</p>
                <input type="hidden" id="deleteId" />
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-danger" id="btnDeleteConfirm">Xóa</button>
            </div>

        </div>
    </div>
</div>




@section Scripts {
    <script src="~/js/api/TeacherAssignments.js"></script>
    <script src="~/js/api/AccountApi.js"></script>
    <script src="~/js/api/SubjectsApi.js"></script>

    <script>
        let editId = null; // id phân công đang sửa
        let deleteId = null; // id phân công đang xóa
        const assignmentModal = new bootstrap.Modal(document.getElementById('assignmentModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // Load danh sách phân công
        function loadAssignments() {
            TeacherAssignmentsApi.getAll()
                .then(data => renderTable(data))
                .catch(err => {
                    console.error("Lỗi API:", err);
                    alert("Không tải được danh sách phân công!");
                });
        }

        // Load combobox Giáo viên và Môn học
        function loadTeachers() {
            AccountApi.getTeachers().then(list => {
                const select = document.getElementById("teacherSelect");
                select.innerHTML = "";
                list.forEach(x => {
                    select.insertAdjacentHTML("beforeend",
                        `<option value="${x.id}">${x.fullName}</option>`);
                });
            });
        }

        function loadSubjects() {
            SubjectsApi.getAll().then(list => {
                const select = document.getElementById("subjectSelect");
                select.innerHTML = "";
                list.forEach(x => {
                    select.insertAdjacentHTML("beforeend",
                        `<option value="${x.id}">${x.name}</option>`);
                });
            });
        }

        // Render bảng
        function renderTable(list) {
            const tbody = document.querySelector("#tblAssignments tbody");
            tbody.innerHTML = "";

            list.forEach((item, index) => {
                const row = `<tr>
                    <td>${index + 1}</td>
                    <td>${item.teacherName}</td>
                    <td>${item.subjectName}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editAssignment(${item.id}, ${item.teacherId}, ${item.subjectId})">Sửa</button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDelete(${item.id})">Xóa</button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        // Thêm/Sửa
        document.addEventListener("DOMContentLoaded", function() {
            loadAssignments();
            loadTeachers();
            loadSubjects();

            // Nút Thêm
            document.getElementById("btnAdd").addEventListener("click", () => {
                editId = null;
                document.getElementById("modalTitle").innerText = "Thêm phân công";
                document.getElementById("teacherSelect").value = "";
                document.getElementById("subjectSelect").value = "";
                assignmentModal.show();
            });

            // Nút Lưu
            document.getElementById("btnSave").addEventListener("click", () => {
                const teacherId = parseInt(document.getElementById("teacherSelect").value);
                const subjectId = parseInt(document.getElementById("subjectSelect").value);

                if(!teacherId || !subjectId){
                    alert("Vui lòng chọn giáo viên và môn học!");
                    return;
                }

                const data = { teacherId, subjectId };

                if(editId){
                    alert("Chưa có API PUT update. Khi có sẽ viết tiếp!");
                    assignmentModal.hide();
                } else {
                    TeacherAssignmentsApi.create(data)
                        .then(res => {
                            assignmentModal.hide();
                            loadAssignments();
                        })
                        .catch(err => alert("Lỗi khi thêm phân công: " + err));
                }
            });

            // Nút Xóa xác nhận
            document.getElementById("btnDeleteConfirm").addEventListener("click", () => {
                if(deleteId){
                    alert("Chưa có API DELETE. Khi có sẽ viết tiếp!");
                    deleteModal.hide();
                }
            });
        });

        // Mở modal Sửa
        function editAssignment(id, teacherId, subjectId){
            editId = id;
            document.getElementById("modalTitle").innerText = "Sửa phân công";
            document.getElementById("teacherSelect").value = teacherId;
            document.getElementById("subjectSelect").value = subjectId;
            assignmentModal.show();
        }

        // Mở modal Xóa
        function confirmDelete(id){
            deleteId = id;
            deleteModal.show();
        }
    </script>
}

