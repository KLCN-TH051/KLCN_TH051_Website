@{
    ViewData["Title"] = "Quản lý tài khoản";
    var apiUrl = ViewData["ApiUrl"]?.ToString();
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<div class="card mb-3">
    <div class="card-body table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Ảnh</th>
                    <th>Họ tên</th>
                    <th>Email</th>
                    <th>Vai trò</th>
                    <th>Ngày tạo</th>
                    <th>Trạng thái</th>
                    <th class="text-end">Tùy chọn</th>
                </tr>
            </thead>
            <tbody id="accountTableBody">
                <!-- JS render -->
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Account Modal -->
<div class="modal fade" id="editAccountModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content p-3">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa tài khoản</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editAccountForm">
                    <div class="text-center mb-4">
                        <img id="editAvatar" src="https://placehold.co/100x100" class="rounded-circle mb-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="btnChangeAvatar">Đổi ảnh</button>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editFullName">Họ tên</label>
                            <input id="editFullName" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label for="editEmail">Email</label>
                            <input id="editEmail" class="form-control" type="email" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editRole">Vai trò</label>
                            <select id="editRole" class="form-select">
                                <option>Giảng viên</option>
                                <option>Sinh viên</option>
                                <option>Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editStatus">Trạng thái</label>
                            <select id="editStatus" class="form-select">
                                <option value="true">Hoạt động</option>
                                <option value="false">Tạm khóa</option>
                            </select>
                        </div>
                    </div>

                    <label for="editPassword">Mật khẩu (nếu đổi)</label>
                    <input id="editPassword" class="form-control mb-3" type="password" placeholder="Nhập mật khẩu mới..." />

                    <button type="submit" class="btn btn-primary">Lưu</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = '@apiUrl/api/Account';
    let accounts = [];

    function getHeaders() {
        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/Admin/Auth/Login';
            return {};
        }
        return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
    }

    async function apiFetch(url, options = {}) {
        const res = await fetch(url, { ...options, headers: getHeaders() });
        if (!res) return null;
        if (res.status === 401 || res.status === 403) {
            localStorage.removeItem('authToken');
            window.location.href = '/Admin/Auth/Login';
            return null;
        }
        return res;
    }

    async function loadAccounts() {
        const res = await apiFetch(API_URL);
        if (!res) return;
        if (!res.ok) return console.error('Không tải được danh sách tài khoản');
        accounts = await res.json();
        renderAccounts();
    }

    function renderAccounts() {
        const tbody = document.getElementById('accountTableBody');
        tbody.innerHTML = accounts.length === 0
            ? '<tr><td colspan="8" class="text-center text-muted">Chưa có tài khoản nào</td></tr>'
            : '';

        accounts.forEach((user, index) => {
            tbody.innerHTML += `
                <tr data-id="${user.id}">
                    <td>${index + 1}</td>
                    <td><img src="${user.avatar || 'https://placehold.co/40x40'}" class="rounded-circle" /></td>
                    <td>${user.fullName}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.role === 'Admin' ? 'bg-danger' : user.role === 'Giảng viên' ? 'bg-info' : 'bg-secondary'}">${user.role}</span></td>
                    <td>${new Date(user.createdDate).toLocaleDateString()}</td>
                    <td><span class="badge ${user.isActive ? 'bg-success' : 'bg-danger'}">${user.isActive ? 'Hoạt động' : 'Tạm khóa'}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary btn-edit"><i class="fa fa-edit"></i></button>
                    </td>
                </tr>
            `;
        });

        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => {
                const tr = btn.closest('tr');
                openEditModal(tr.dataset.id);
            });
        });
    }

    function openEditModal(userId) {
        const user = accounts.find(u => u.id == userId);
        if (!user) return;

        document.getElementById('editFullName').value = user.fullName;
        document.getElementById('editEmail').value = user.email;
        document.getElementById('editPassword').value = '';
        document.getElementById('editRole').value = user.role;
        document.getElementById('editStatus').value = user.isActive ? 'true' : 'false';
        document.getElementById('editAvatar').src = user.avatar || 'https://placehold.co/100x100';

        const modal = new bootstrap.Modal(document.getElementById('editAccountModal'));
        modal.show();

        document.getElementById('editAccountForm').onsubmit = async e => {
            e.preventDefault();
            const model = {
                fullName: document.getElementById('editFullName').value,
                email: document.getElementById('editEmail').value,
                role: document.getElementById('editRole').value,
                isActive: document.getElementById('editStatus').value === 'true',
                password: document.getElementById('editPassword').value || null
            };
            const res = await apiFetch(`${API_URL}/${userId}`, { method: 'PUT', body: JSON.stringify(model) });
            if (res && res.ok) {
                alert('Cập nhật tài khoản thành công!');
                modal.hide();
                loadAccounts();
            } else {
                alert('Cập nhật thất bại!');
            }
        };
    }

    document.addEventListener('DOMContentLoaded', loadAccounts);
</script>
