@{
    ViewData["Title"] = "Danh sách phân công giáo viên";
}
<!-- WRAPPER CARD -->
<div class="card shadow-sm p-4">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center">
        <h3>Danh sách phân công giáo viên</h3>
        <button class="btn btn-primary" id="btnAdd">+ Thêm phân công</button>
    </div>

    <table class="table table-bordered" id="tblAssignments">
        <thead>
            <tr>
                <th>ID</th>
                <th>Giáo viên</th>
                <th>Môn học</th>
                <th style="width: 140px;">Tùy chọn</th>
            </tr>
        </thead>
        <tbody id="tblAssignmentsBody"></tbody>
    </table>
</div>

<!-- ========================================================= -->
<!-- POPUP THÊM + SỬA (DÙNG CHUNG) -->
<!-- ========================================================= -->
<div class="modal fade" id="assignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm phân công</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="assignmentId" />

                <div class="mb-3">
                    <label>Giáo viên</label>
                    <select class="form-select" id="teacherSelect"></select>
                </div>

                <div class="mb-3">
                    <label>Môn học</label>
                    <select class="form-select" id="subjectSelect"></select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-primary" id="btnSave">Lưu</button>
            </div>

        </div>
    </div>
</div>


<!-- ========================================================= -->
<!-- POPUP XÓA -->
<!-- ========================================================= -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Xóa phân công</h5>
            </div>

            <div class="modal-body">
                <p>Bạn có chắc muốn xóa phân công này?</p>
                <input type="hidden" id="deleteId" />
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button class="btn btn-danger" id="btnDeleteConfirm">Xóa</button>
            </div>

        </div>
    </div>
</div>
@section Scripts {
    <script type="module" src="~/js/modules/teacherAssignments/teacherAssignments.init.js"></script>
    <script type="module" src="~/js/modules/teacherassignments/teacherassignments.index.js"></script>

}

@* @section Scripts {

    <script src="~/js/api/AccountApi.js"></script>
    <script src="~/js/api/SubjectApi.js"></script>
    <script src="~/js/api/TeacherAssignments.js"></script>
    <script src="~/js/components/Toast.js"></script>

    <script>
        $(document).ready(function () {

            // ============================================
            // LOAD DANH SÁCH PHÂN CÔNG
            // ============================================
            function loadAssignments() {
                TeacherAssignmentsApi.getAll()
                    .then(data => {

                        let tbody = $("#tblAssignments tbody");
                        tbody.empty();

                        if (!data || data.length === 0) {
                            tbody.append(`
                                <tr>
                                    <td colspan="4" class="text-center">Không có dữ liệu</td>
                                </tr>
                            `);
                            return;
                        }

                        data.forEach(item => {
                            tbody.append(`
                                <tr>
                                    <td>${item.id}</td>
                                    <td>${item.teacherName}</td>
                                    <td>${item.subjectName}</td>
                                    <td class="text-center">
                                        <button class="btn btn-warning btn-sm btnEdit" data-id="${item.id}">Sửa</button>
                                        <button class="btn btn-danger btn-sm btnDelete" data-id="${item.id}">Xóa</button>
                                    </td>
                                </tr>
                            `);
                        });

                    })
                    .catch(err => console.error("Lỗi load assignments:", err));
            }

            loadAssignments(); // load lần đầu

            // ============================================
            // LOAD COMBOBOX GIÁO VIÊN + MÔN HỌC
            // ============================================
            function loadTeacherAndSubjectDropdowns() {

                // Giáo viên
                AccountApi.getTeachers().then(teachers => {
                    let teacherSelect = $("#teacherSelect");
                    teacherSelect.empty();
                    teachers.forEach(t => {
                        teacherSelect.append(`<option value="${t.id}">${t.fullName}</option>`);
                    });
                });

                // Môn học
                SubjectApi.getAll().then(subjects => {
                    let subjectSelect = $("#subjectSelect");
                    subjectSelect.empty();
                    subjects.forEach(s => {
                        subjectSelect.append(`<option value="${s.id}">${s.name}</option>`);
                    });
                });
            }

            // ============================================
            // NÚT THÊM
            // ============================================
            $("#btnAdd").click(function () {
                $("#assignmentId").val("");
                $("#modalTitle").text("Thêm phân công");

                loadTeacherAndSubjectDropdowns();
                $("#assignmentModal").modal("show");
            });

            // ============================================
            // NÚT SỬA
            // ============================================
            $(document).on("click", ".btnEdit", function () {
                let id = $(this).data("id");

                $("#assignmentId").val(id);
                $("#modalTitle").text("Sửa phân công");

                loadTeacherAndSubjectDropdowns();
                $("#assignmentModal").modal("show");
            });

            // ============================================
            // NÚT XÓA
            // ============================================
            $(document).on("click", ".btnDelete", function () {
                let id = $(this).data("id");
                $("#deleteId").val(id);
                $("#deleteModal").modal("show");
            });

            $("#btnDeleteConfirm").click(function () {
                let id = $("#deleteId").val();

                TeacherAssignmentsApi.remove(id)
                    .then(() => {
                        $("#deleteModal").modal("hide");
                        loadAssignments();
                        Toast.show("Xóa phân công thành công!", "success");
                    })
                    .catch(err => Toast.show("Lỗi khi xóa phân công!", "danger"));
            });

            // ============================================
            // NÚT LƯU (THÊM / SỬA)
            // ============================================
            $("#btnSave").click(function () {
                let id = $("#assignmentId").val();
                let teacherId = $("#teacherSelect").val();
                let subjectId = $("#subjectSelect").val();

                let payload = {
                    teacherId: parseInt(teacherId),
                    subjectId: parseInt(subjectId)
                };

                // Kiểm tra trùng môn học với giáo viên
                TeacherAssignmentsApi.getAll()
                    .then(allAssignments => {

                        let duplicate = allAssignments.some(a =>
                            a.teacherId === payload.teacherId &&
                            a.subjectId === payload.subjectId &&
                            (!id || a.id !== parseInt(id)) // bỏ qua chính bản thân khi sửa
                        );

                        if (duplicate) {
                            Toast.show("Giáo viên này đã được phân công môn học này rồi!", "danger");
                            return;
                        }

                        if (id) {
                            // Sửa
                            TeacherAssignmentsApi.update(id, payload)
                                .then(() => {
                                    $("#assignmentModal").modal("hide");
                                    loadAssignments();
                                    Toast.show("Cập nhật phân công thành công!", "success");
                                })
                                .catch(err => Toast.show("Lỗi khi cập nhật phân công!", "danger"));
                        } else {
                            // Thêm mới
                            TeacherAssignmentsApi.create(payload)
                                .then(() => {
                                    $("#assignmentModal").modal("hide");
                                    loadAssignments();
                                    Toast.show("Thêm phân công thành công!", "success");
                                })
                                .catch(err => Toast.show("Lỗi khi thêm phân công!", "danger"));
                        }

                    })
                    .catch(err => Toast.show("Lỗi khi kiểm tra dữ liệu!", "danger"));
            });

        });
    </script>

} *@

