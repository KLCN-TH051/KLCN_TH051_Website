@model int // Nhận lessonId từ route hoặc query

@{
    ViewData["Title"] = "Chi tiết bài học";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Loading spinner -->
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-3">Đang tải chi tiết bài học...</p>
            </div>

            <!-- Nội dung bài học -->
            <div id="lessonContent" class="card shadow-sm" style="display: none;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 id="lessonTitle" class="mb-0">Tiêu đề bài học</h4>
                    <span id="lessonFreeBadge" class="badge bg-light text-success fs-6" style="display:none;">
                        Miễn phí
                    </span>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center text-muted mb-4">
                        <i id="lessonTypeIcon" class="bi bi-journal-text me-2 fs-4"></i>
                        <span id="lessonTypeText" class="me-3">Bài đọc</span>
                        <span id="lessonDuration" class="me-3"></span>
                        <small class="text-muted">Cập nhật: <span id="lastUpdated"></span></small>
                    </div>

                    <!-- Nội dung bài học -->
                    <div id="contentContainer">
                        <!-- Sẽ được điền bằng JS -->
                    </div>
                </div>
            </div>

            <!-- Nút quay lại -->
            <div class="mt-4">
                <a href="javascript:history.back()" class="btn btn-outline-secondary">
                    Quay lại danh sách
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script type="module">
        import BaseApi from "/js/api/core/BaseApi.js";

        // Lấy lessonId từ URL hoặc Model
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = @Model || parseInt(urlParams.get("id")) || 0;
        const chapterId = parseInt(urlParams.get("chapterId")) || 0;

        if (!lessonId || !chapterId) {
            document.getElementById("loading").innerHTML = `
                <div class="alert alert-danger">
                    <strong>Lỗi:</strong> Không tìm thấy bài học. Vui lòng thử lại!
                </div>`;
            throw new Error("Missing lessonId or chapterId");
        }

        // Gọi API lấy chi tiết bài học
        async function loadLessonDetail() {
            try {
                const response = await fetch(`/api/chapters/${chapterId}/lessons/${lessonId}`, {
                    headers: {
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) throw new Error("Không tải được bài học");

                const lesson = await response.json();

                // Ẩn loading, hiện nội dung
                document.getElementById("loading").style.display = "none";
                document.getElementById("lessonContent").style.display = "block";

                // Điền dữ liệu
                document.getElementById("lessonTitle").textContent = lesson.title || "Không có tiêu đề";

                if (lesson.isFree) {
                    document.getElementById("lessonFreeBadge").style.display = "inline-block";
                }

                // Icon + loại bài học
                const typeInfo = {
                    1: { icon: "bi-journal-text text-primary", text: "Bài đọc" },
                    2: { icon: "bi-play-circle text-success", text: "Video" },
                    3: { icon: "bi-question-circle text-warning", text: "Quiz" }
                };

                const info = typeInfo[lesson.type] || typeInfo[1];
                document.getElementById("lessonTypeIcon").className = `bi ${info.icon} me-2 fs-4`;
                document.getElementById("lessonTypeText").textContent = info.text;

                // Thời lượng
                if (lesson.durationMinutes > 0) {
                    const h = Math.floor(lesson.durationMinutes / 60);
                    const m = lesson.durationMinutes % 60;
                    document.getElementById("lessonDuration").textContent = `· ${h}:${m.toString().padStart(2, '0')}`;
                }

                // Ngày cập nhật
                if (lesson.lastUpdatedDate) {
                    const date = new Date(lesson.lastUpdatedDate);
                    document.getElementById("lastUpdated").textContent = date.toLocaleDateString("vi-VN");
                }

                // HIỂN THỊ NỘI DUNG THEO LOẠI
                const container = document.getElementById("contentContainer");
                container.innerHTML = "";

                if (lesson.type === 1) {
                    // Bài đọc - dùng Quill để render đẹp
                    container.innerHTML = `<div class="quill-viewer">${lesson.content || "<p>Chưa có nội dung</p>"}</div>`;

                    // Optional: Khởi tạo Quill viewer (chỉ đọc)
                    document.querySelectorAll('.quill-viewer').forEach(el) => {
                        new Quill(el, { readOnly: true, theme: 'bubble' });
                    };
                }
                else if (lesson.type === 2 && lesson.videoUrl) {
                    // Video
                    const videoId = extractYouTubeId(lesson.videoUrl);
                    if (videoId) {
                        container.innerHTML = `
                            <div class="ratio ratio-16x9 mb-4">
                                <iframe src="https://www.youtube.com/embed/${videoId}"
                                        allowfullscreen
                                        class="rounded shadow">
                                </iframe>
                            </div>`;
                    } else {
                        container.innerHTML = `<p><strong>Video:</strong> ${lesson.videoUrl}</p>`;
                    }
                }
                else if (lesson.type === 3) {
                    container.innerHTML = `<div class="alert alert-info">Quiz sẽ được hiển thị tại đây (sắp ra mắt)</div>`;
                }
                else {
                    container.innerHTML = `<p class="text-muted">Chưa có nội dung cho loại bài học này.</p>`;
                }

            } catch (err) {
                console.error(err);
                document.getElementById("loading").innerHTML = `
                    <div class="alert alert-danger text-center">
                        <h5>Không thể tải bài học</h5>
                        <p>${err.message}</p>
                        <a href="javascript:history.back()" class="btn btn-outline-danger mt-3">Quay lại</a>
                    </div>`;
            }
        }

        // Helper: Lấy YouTube ID
        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Chạy khi load trang
        document.addEventListener("DOMContentLoaded", loadLessonDetail);
    </script>
}